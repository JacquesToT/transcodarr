#!/bin/bash
#
# Jellyfin + rffmpeg Setup Module for Transcodarr
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Generate SSH key pair for Mac Mini access
generate_ssh_key() {
    local jellyfin_path="$1"
    local ssh_dir="${jellyfin_path}/rffmpeg/.ssh"
    local key_file="${ssh_dir}/id_rsa"

    gum style --foreground 212 "Generating SSH key pair..."

    mkdir -p "$ssh_dir"

    if [[ -f "$key_file" ]]; then
        if gum confirm "SSH key already exists. Regenerate?"; then
            rm -f "$key_file" "${key_file}.pub"
        else
            gum style --foreground 46 "âœ“ Using existing SSH key"
            return 0
        fi
    fi

    ssh-keygen -t ed25519 -f "$key_file" -N "" -C "transcodarr-rffmpeg"

    # Set correct permissions
    chmod 600 "$key_file"
    chmod 644 "${key_file}.pub"

    gum style --foreground 46 "âœ“ SSH key pair generated"
    echo ""
    gum style --foreground 212 "ðŸ“‹ Copy this public key to your Mac Mini:"
    echo ""
    gum style --foreground 39 --border normal --padding "0 1" "$(cat ${key_file}.pub)"
    echo ""
    gum style --foreground 252 "Add it to ~/.ssh/authorized_keys on the Mac Mini"
}

# Create rffmpeg configuration
create_rffmpeg_config() {
    local mac_ip="$1"
    local mac_user="$2"
    local jellyfin_path="$3"
    local config_file="${jellyfin_path}/rffmpeg/rffmpeg.yml"

    gum style --foreground 212 "Creating rffmpeg configuration..."

    mkdir -p "$(dirname "$config_file")"

    cat > "$config_file" << EOF
# Transcodarr - rffmpeg Configuration
# Generated by Transcodarr Installer

rffmpeg:
    logging:
        log_to_file: true
        logfile: "/config/log/rffmpeg.log"
        debug: false

    directories:
        state: "/config/rffmpeg"
        persist: "/config/rffmpeg/persist"
        owner: abc
        group: abc

    remote:
        user: "${mac_user}"
        persist: 300
        args:
            - "-o"
            - "StrictHostKeyChecking=no"
            - "-o"
            - "UserKnownHostsFile=/dev/null"
            - "-i"
            - "/config/rffmpeg/.ssh/id_rsa"

    commands:
        ssh: "/usr/bin/ssh"
        # FFmpeg paths on Mac Mini (Homebrew)
        ffmpeg: "/opt/homebrew/bin/ffmpeg"
        ffprobe: "/opt/homebrew/bin/ffprobe"
        # Fallback to local ffmpeg if all remotes fail
        fallback_ffmpeg: "/usr/lib/jellyfin-ffmpeg/ffmpeg"
        fallback_ffprobe: "/usr/lib/jellyfin-ffmpeg/ffprobe"
EOF

    gum style --foreground 46 "âœ“ rffmpeg.yml created at ${config_file}"
}

# Create Docker Compose file
create_docker_compose() {
    local mac_ip="$1"
    local jellyfin_path="$2"
    local compose_file="${SCRIPT_DIR}/../docker-compose.yml"

    gum style --foreground 212 "Creating Docker Compose configuration..."

    cat > "$compose_file" << EOF
# Transcodarr - Jellyfin with rffmpeg
# Distributed transcoding to Mac Mini's with Apple Silicon

services:
  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=1000          # Change to your user ID
      - PGID=1000          # Change to your group ID
      - TZ=Europe/Amsterdam
      - JELLYFIN_PublishedServerUrl=YOUR_SERVER_IP
      - UMASK=022
      # Enable rffmpeg mod for distributed transcoding
      - DOCKER_MODS=linuxserver/mods:jellyfin-rffmpeg
      - FFMPEG_PATH=/usr/local/bin/ffmpeg
    volumes:
      - ${jellyfin_path}:/config
      - /path/to/media:/data/media
      # Transcoding cache (local recommended for stability)
      - ${jellyfin_path}/cache:/config/cache
    ports:
      - 8096:8096/tcp      # HTTP
      - 8920:8920/tcp      # HTTPS
      - 7359:7359/udp      # Discovery
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

# Optional: Use NFS volume for transcoding cache (if Mac Mini is NFS server)
# volumes:
#   macmini-cache:
#     driver: local
#     driver_opts:
#       type: nfs
#       o: addr=${mac_ip},rw,nolock,vers=3,soft,timeo=10,retrans=3
#       device: ":/Users/Shared/jellyfin-cache"
EOF

    gum style --foreground 46 "âœ“ docker-compose.yml created"
    echo ""
    gum style --foreground 226 "âš  Remember to update PUID, PGID, and paths in docker-compose.yml"
}

# Create helper script for adding Mac Mini nodes
create_add_node_script() {
    local script_file="${SCRIPT_DIR}/../scripts/add-mac-node.sh"

    mkdir -p "$(dirname "$script_file")"

    cat > "$script_file" << 'EOF'
#!/bin/bash
#
# Add a Mac Mini node to rffmpeg
#

if [[ $# -lt 2 ]]; then
    echo "Usage: $0 <mac-ip> <weight>"
    echo "Example: $0 192.168.1.50 2"
    exit 1
fi

MAC_IP="$1"
WEIGHT="${2:-2}"

echo "Adding Mac Mini node: $MAC_IP with weight $WEIGHT"
docker exec jellyfin rffmpeg add "$MAC_IP" --weight "$WEIGHT"

echo ""
echo "Verifying..."
docker exec jellyfin rffmpeg status
EOF

    chmod +x "$script_file"
    gum style --foreground 46 "âœ“ Helper script created: scripts/add-mac-node.sh"
}

# Create helper script for testing SSH connection
create_test_ssh_script() {
    local script_file="${SCRIPT_DIR}/../scripts/test-ssh.sh"

    mkdir -p "$(dirname "$script_file")"

    cat > "$script_file" << 'EOF'
#!/bin/bash
#
# Test SSH connection from Jellyfin container to Mac Mini
#

if [[ $# -lt 2 ]]; then
    echo "Usage: $0 <mac-user> <mac-ip>"
    echo "Example: $0 'Nick Roodenrijs' 192.168.1.50"
    exit 1
fi

MAC_USER="$1"
MAC_IP="$2"

echo "Testing SSH connection to ${MAC_USER}@${MAC_IP}..."
docker exec -u abc jellyfin ssh \
    -o StrictHostKeyChecking=no \
    -i /config/rffmpeg/.ssh/id_rsa \
    "${MAC_USER}@${MAC_IP}" \
    "/opt/homebrew/bin/ffmpeg -version"

if [[ $? -eq 0 ]]; then
    echo ""
    echo "âœ“ SSH connection successful!"
else
    echo ""
    echo "âœ— SSH connection failed. Check:"
    echo "  1. Mac Mini Remote Login is enabled"
    echo "  2. SSH public key is in ~/.ssh/authorized_keys"
    echo "  3. Firewall allows SSH (port 22)"
fi
EOF

    chmod +x "$script_file"
    gum style --foreground 46 "âœ“ Helper script created: scripts/test-ssh.sh"
}

# Display post-setup instructions
show_post_setup_instructions() {
    local mac_ip="$1"
    local mac_user="$2"

    echo ""
    gum style --foreground 212 --border double --padding "1 2" \
        "ðŸ“‹ Post-Setup Instructions"

    echo ""
    gum style --foreground 252 "1. Copy the SSH public key to your Mac Mini:"
    gum style --foreground 39 "   ssh-copy-id -i /path/to/id_rsa.pub '${mac_user}@${mac_ip}'"

    echo ""
    gum style --foreground 252 "2. Start Jellyfin container:"
    gum style --foreground 39 "   docker compose up -d"

    echo ""
    gum style --foreground 252 "3. Wait for container to start, then add Mac Mini:"
    gum style --foreground 39 "   docker exec jellyfin rffmpeg add ${mac_ip} --weight 2"

    echo ""
    gum style --foreground 252 "4. Verify the setup:"
    gum style --foreground 39 "   docker exec jellyfin rffmpeg status"

    echo ""
    gum style --foreground 252 "5. Test SSH connection:"
    gum style --foreground 39 "   ./scripts/test-ssh.sh '${mac_user}' ${mac_ip}"
}

# Main setup function
run_jellyfin_setup() {
    local mac_ip="$1"
    local mac_user="$2"
    local jellyfin_path="$3"

    gum style --foreground 212 "Starting Jellyfin + rffmpeg setup..."
    echo ""

    generate_ssh_key "$jellyfin_path"
    create_rffmpeg_config "$mac_ip" "$mac_user" "$jellyfin_path"
    create_docker_compose "$mac_ip" "$jellyfin_path"
    create_add_node_script
    create_test_ssh_script

    show_post_setup_instructions "$mac_ip" "$mac_user"
}
